<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Administración - Confirmaciones</title>
    <style>
      body {
        font-family: 'Arial', sans-serif;
        padding: 20px;
        background-color: #f8f9fa;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #4a6baf;
        margin-bottom: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 14px;
      }
      th,
      td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }
      th {
        background-color: #f0f4f8;
        font-weight: bold;
      }
      tr:hover {
        background-color: #f5f5f5;
      }
      .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .stat-box {
        flex: 1;
        background-color: #f0f4f8;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #4a6baf;
        margin: 10px 0;
      }
      .stat-label {
        color: #666;
      }
      .btn {
        padding: 8px 15px;
        background-color: #4a6baf;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      .btn:hover {
        background-color: #3a569f;
      }
      .btn-danger {
        background-color: #dc3545;
      }
      .btn-danger:hover {
        background-color: #c82333;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Panel de Confirmaciones (Datos Locales)</h1>

      <div class="stats">
        <div class="stat-box">
          <div class="stat-label">Total de Confirmaciones</div>
          <div
            class="stat-value"
            id="total-confirmations"
          >
            0
          </div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Asistirán</div>
          <div
            class="stat-value"
            id="attending"
          >
            0
          </div>
        </div>
        <div class="stat-box">
          <div class="stat-label">No Asistirán</div>
          <div
            class="stat-value"
            id="not-attending"
          >
            0
          </div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total de Invitados</div>
          <div
            class="stat-value"
            id="total-guests"
          >
            0
          </div>
        </div>
      </div>

      <button
        id="export-csv"
        class="btn"
      >
        Exportar a CSV
      </button>
      <button
        id="clear-data"
        class="btn btn-danger"
      >
        Borrar todos los datos
      </button>

      <div class="table-responsive">
        <table id="confirmations-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Teléfono</th>
              <th>Asistencia</th>
              <th>Invitados</th>
              <th>Restricciones</th>
              <th>Mensaje</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <!-- Datos se cargarán aquí -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Cargar datos del localStorage
        function loadData() {
          const confirmations = JSON.parse(
            localStorage.getItem('eventConfirmations') || '[]'
          );
          return confirmations;
        }

        // Mostrar datos en la tabla
        function displayData() {
          const confirmations = loadData();
          const tableBody = document.getElementById('table-body');
          tableBody.innerHTML = '';

          // Contador de estadísticas
          let attending = 0;
          let notAttending = 0;
          let totalGuests = 0;

          confirmations.forEach((item) => {
            const row = document.createElement('tr');

            // Formatear fecha
            const date = new Date(item.date);
            const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

            // Actualizar estadísticas
            if (item.attendance.includes('Sí')) {
              attending++;
              totalGuests += parseInt(item.guests) || 0;
            } else {
              notAttending++;
            }

            // Crear celdas
            row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${item.name || ''}</td>
                        <td>${item.email || ''}</td>
                        <td>${item.phone || ''}</td>
                        <td>${item.attendance || ''}</td>
                        <td>${item.guests || '0'}</td>
                        <td>${item.dietary || ''}</td>
                        <td>${item.message || ''}</td>
                    `;

            tableBody.appendChild(row);
          });

          // Actualizar estadísticas
          document.getElementById('total-confirmations').textContent =
            confirmations.length;
          document.getElementById('attending').textContent = attending;
          document.getElementById('not-attending').textContent = notAttending;
          document.getElementById('total-guests').textContent = totalGuests;
        }

        // Exportar a CSV
        document
          .getElementById('export-csv')
          .addEventListener('click', function () {
            const confirmations = loadData();
            if (confirmations.length === 0) {
              alert('No hay datos para exportar');
              return;
            }

            // Cabeceras CSV
            let csvContent =
              'Fecha,Nombre,Email,Teléfono,Asistencia,Invitados,Restricciones,Mensaje\n';

            // Añadir cada fila
            confirmations.forEach((item) => {
              const date = new Date(item.date);
              const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

              // Escapar comillas en los campos
              const row = [
                formattedDate,
                `"${(item.name || '').replace(/"/g, '""')}"`,
                `"${(item.email || '').replace(/"/g, '""')}"`,
                `"${(item.phone || '').replace(/"/g, '""')}"`,
                `"${(item.attendance || '').replace(/"/g, '""')}"`,
                item.guests || '0',
                `"${(item.dietary || '').replace(/"/g, '""')}"`,
                `"${(item.message || '').replace(/"/g, '""')}"`,
              ].join(',');

              csvContent += row + '\n';
            });

            // Crear enlace de descarga
            const blob = new Blob([csvContent], {
              type: 'text/csv;charset=utf-8;',
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');

            link.setAttribute('href', url);
            link.setAttribute('download', 'confirmaciones_evento.csv');
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          });

        // Borrar todos los datos
        document
          .getElementById('clear-data')
          .addEventListener('click', function () {
            if (
              confirm(
                '¿Estás seguro de que quieres borrar todos los datos? Esta acción no se puede deshacer.'
              )
            ) {
              localStorage.removeItem('eventConfirmations');
              displayData();
              alert('Todos los datos han sido eliminados');
            }
          });

        // Cargar datos al inicio
        displayData();
      });
    </script>
  </body>
</html>
